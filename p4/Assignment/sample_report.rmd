---
title: ''
output:
  pdf_document:
    pandoc_args: [ 
      "--latex-engine", "xelatex" 
    ]
  html_notebook: default
  html_document: default
---

```{r message=FALSE, warning=FALSE, echo=FALSE, libs}
library(ggthemes)
library(ggplot2)
library(tidyr)
library(dplyr)
library(GGally)
library(gridExtra)
library(knitr)
```

```{r message=FALSE, warning=FALSE, echo=FALSE, constants}
LOCATION_NAME <-  'Bali, Indonesia'
```

```{r message=FALSE, warning=FALSE, echo=FALSE, settings}
theme_set(theme_bw())
```

```{r echo=FALSE, message=FALSE, Load_the_Data}
listings_df <- read.csv('data/airbnb.listings.bali.csv')
calendar_df <- read.csv('data/airbnb.listing.calendar.dates.bali.csv')

```

```{r echo=FALSE, message=FALSE}
calendar_df$available = as.logical(calendar_df$available == "true")

```

```{r echo=FALSE, warning=FALSE, message=FALSE, Creation_of_high_level_dataframe}

 daily_revenue <- function(available, price) {
    ifelse(available == FALSE, price, 0)
 }

 average_daily_rate <- function(available, revenue) {
   if(length(which(available==FALSE)) > 0){
      revenue / length(which(available==FALSE))
   }
   else{
      0
   }
 }

 occupancy <- function(available) {
    length(which(available==FALSE)) / length(available)
 }
 
 revenue_per_available_room <- function(available, revenue) {
    average_daily_rate(available, revenue) * occupancy(available)
 }
 
 yearly_revenue <- function(available, revenue) {
    365 * revenue_per_available_room(available,revenue)
 }
 
# Calculation of metrics and join into the listings dataframe
listings_df <- calendar_df %>% 
          mutate(daily_revenue=daily_revenue(available, price.local_price)) %>% 
          group_by(id) %>% 
          summarize(currency=first(price.local_currency),
                    occupancy=occupancy(available),
                    revenue_per_available_room=revenue_per_available_room(available, sum(daily_revenue)),
                    average_daily_rate=average_daily_rate(available, sum(daily_revenue)),
                    yearly_revenue=yearly_revenue(available, sum(daily_revenue))
                    ) %>%
          right_join(listings_df)  
listings_df$star_rating = as.factor(listings_df$star_rating)
listings_df <-  listings_df[ , -which(names(listings_df) %in% c("picture_url", "currency"))]

listings_df$reviews_count_bucket <- cut(listings_df$reviews_count, 
                                        breaks =c(0,20,40,60,10000), 
                                        labels = c('-20','20-40','40-60','60+')) 
listings_df$picture_count_bucket <- cut(listings_df$picture_count, 
                                        breaks =c(0,10,20,30,40,50,10000), 
                                        labels = c('-10','10-20','20-30','30-40','40-50','50+'))
listings_df$adr_bucket <- cut(listings_df$average_daily_rate, 
                                        breaks =c(0,40,60,80,100,120,140,180,220,300,400,500,1000000), 
                                        labels = 
                                c('-40','40-60','60-80','80-100',
                                  '100-120','120-140','140-180','180-220','220-300','300-400','400-500','500+')) 
listings_df$price_category = cut(listings_df$average_daily_rate, 
                                        breaks =c(0,20,60,120,200,100000), 
                                        labels = 
                                c('cheap','budget','midclass','upper','luxury')) 
```

# Airbnb market analysis for `r LOCATION_NAME`


## Yearly revenue


```{r echo=FALSE, message=FALSE, warning=FALSE}

median_yearly_revenue <- round(median(listings_df$yearly_revenue,na.rm = TRUE), digits=0)
upper_yearly_revenue <- round(quantile(listings_df$yearly_revenue, probs=c(0.75), na.rm = TRUE), digits=0)
lower_yearly_revenue <- round(quantile(listings_df$yearly_revenue, probs=c(0.25), na.rm = TRUE), digits=0)
without_ouliers_yearly_revenue <- round(quantile(listings_df$yearly_revenue, probs=c(0.01, 0.99), na.rm = TRUE), digits=0)
```


The median for yearly revenue: EUR `r as.integer(median_yearly_revenue)`

50% of all listings have a yearly revenue between 
EUR `r as.integer(lower_yearly_revenue)` and EUR `r as.integer(upper_yearly_revenue)`



```{r echo=FALSE, message=FALSE, warning=FALSE}


p1 <- ggplot(data=listings_df, mapping=aes(x=yearly_revenue)) +
  geom_histogram(alpha=0.3, fill='blue', color='black') +
  scale_x_log10(breaks=c(100,200,500,1000,2000,5000,10000,20000,50000,100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
  labs(x='Yearly revenue', y='Number of listings', fill='Room Type', title='Distribution of yearly revenue of Airbnb listing in Bali, Indonesia')

p2 <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue,x=as.factor(''))) +
             geom_boxplot(alpha=0.3, fill= 'blue') +  
             scale_y_log10(breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
             labs(x='', y='Yearly revenue')
             
ggsave(file="yearly_revenue.png", grid.arrange(p1, p2, nrow=2))

grid.arrange(p1, p2, nrow=2)
p2
```


### Yearly revenue by Average Daily Rate


```{r echo=FALSE, message=FALSE, warning=FALSE}

yr_adr_pl <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue, x=adr_bucket)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= adr_bucket)) +   
              scale_y_log10(breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
              labs(x='Average Daily Rate', fill='Average Daily Rate', y='Yearly revenue')
             
ggsave(file="yearly_revenue_by_adr.png", yr_adr_pl)
yr_adr_pl
```



### Yearly revenue by person capacity


```{r echo=FALSE, message=FALSE, warning=FALSE}

yr_pc_pl <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue, x=as.factor(person_capacity))) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= as.factor(person_capacity))) +    
              scale_y_log10(breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
              labs(x='Person Capacity', fill='Person Capacity',y='Yearly revenue')
             
ggsave(file="yearly_revenue_per_person_capacity.png", yr_pc_pl)
yr_pc_pl
```


### Yearly revenue by room type


```{r echo=FALSE, message=FALSE, warning=FALSE}

yr_rt_pl <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue, x=room_type)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= room_type)) +   
              scale_y_log10(breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
              labs(x='Room Type', fill='Room Type', y='Yearly revenue')
             
ggsave(file="yearly_revenue_by_room_type.png", yr_rt_pl)
yr_rt_pl
```

### Yearly revenue by price category


```{r echo=FALSE, message=FALSE, warning=FALSE}
yr_pc_pl <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue, x=price_category)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= price_category)) +   
              scale_y_log10(breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
              labs(x='Price category', fill='Price category', y='Yearly revenue')
             
ggsave(file="yearly_revenue_by_price_category.png", yr_pc_pl)
yr_pc_pl
```



### Yearly revenue by Rating


```{r echo=FALSE, message=FALSE, warning=FALSE}

yr_sr_pl <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue, x=star_rating)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= star_rating)) +   
              scale_y_log10(breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
              labs(x='Star rating', fill='Star rating', y='Yearly revenue')
             
ggsave(file="yearly_revenue_by_star_rating.png", yr_sr_pl)
yr_sr_pl
```


### Yearly revenue by Revenue Count



```{r echo=FALSE, message=FALSE, warning=FALSE}

yr_rc_pl <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue, x=reviews_count_bucket)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= reviews_count_bucket)) +   
              scale_y_log10(breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
              labs(x='Revenue Count', fill='Revenue Count', y='Yearly revenue')
             
ggsave(file="yearly_revenue_by_revenue_count.png", yr_rc_pl)
yr_rc_pl
```


### Yearly revenue by Picture Count


```{r echo=FALSE, message=FALSE, warning=FALSE}

yr_pc_pl <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue, x=picture_count_bucket)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= picture_count_bucket)) +   
              scale_y_log10(breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
              labs(x='Picture Count', fill='Picture Count', y='Yearly revenue')
             
ggsave(file="yearly_revenue_by_picture_count.png", yr_pc_pl)
yr_pc_pl
```

## Occupancy


```{r echo=FALSE, message=FALSE, warning=FALSE}

median_occupancy <- round(median(listings_df$occupancy,na.rm = TRUE)*100, digits=1)

upper_occupancy <- round(quantile(listings_df$occupancy, probs=c(0.75), na.rm = TRUE) * 100, digits=1)
lower_occupancy <- round(quantile(listings_df$occupancy, probs=c(0.25), na.rm = TRUE) * 100, digits=1)

without_ouliers_occupancy <- round(quantile(listings_df$occupancy, probs=c(0.01, 0.99), na.rm = TRUE) * 100, digits=1)

```


The median for occupancy: `r as.integer(median_occupancy)`%

50% of all listings have a occupancy between 
`r as.integer(lower_occupancy)`% and `r as.integer(upper_occupancy)`%


```{r echo=FALSE, message=FALSE, warning=FALSE}


p3 <- ggplot(data=listings_df, mapping=aes(x=occupancy * 100)) +
        geom_histogram(alpha=0.3, fill='red', color='black') +
        scale_x_continuous(breaks=seq(0,100,10)) +
        coord_cartesian(xlim=without_ouliers_occupancy) +
        labs( x='Occupancy in %', y='Number of listings', title='Occupancy of Airbnb listings')

p4 <- ggplot(data=listings_df, mapping=aes(y=occupancy * 100, x=as.factor(''))) +
        geom_boxplot(alpha=0.3, fill='red') +
        scale_y_continuous(breaks=seq(0,100,10)) +
        coord_cartesian(ylim=c(0, upper_occupancy * 1.2)) +
        labs(y='Occupancy in %', x='')
             
ggsave(file="occupancy.png", grid.arrange(p3, p4, nrow=2))

grid.arrange(p3, p4, nrow=2)
```

### Occupancy by Average Daily Rate


```{r echo=FALSE, message=FALSE, warning=FALSE}

occ_adr_pl <- ggplot(data=listings_df, mapping=aes(y=occupancy * 100, x=adr_bucket)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= adr_bucket)) + 
              labs(x='Average Daily Rate', fill='Average Daily Rate', y='Occupancy in %')
             
ggsave(file="occ_by_adr.png", occ_adr_pl)
occ_adr_pl
```


### Occupancy by person capacity


```{r echo=FALSE, message=FALSE, warning=FALSE}

occ_pc_pl <- ggplot(data=listings_df, mapping=aes(y=occupancy * 100, x=as.factor(person_capacity))) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= as.factor(person_capacity))) + 
              labs(x='Person Capacity', fill='Person Capacity',y='Occupancy in %')
             
ggsave(file="occupancy_per_person_capacity.png", occ_pc_pl)
occ_pc_pl
```



### Occupancy by Room Type


```{r echo=FALSE, message=FALSE, warning=FALSE}

occ_rt_pl <- ggplot(data=listings_df, mapping=aes(y=occupancy * 100, x=room_type)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= room_type)) + 
              labs(x='Room type', fill='Room Type',y='Occupancy in %')
             
ggsave(file="occupancy_per_room_type.png", occ_rt_pl)
occ_rt_pl
```




### Occupancy by Star Rating


```{r echo=FALSE, message=FALSE, warning=FALSE}

occ_sr_pl <- ggplot(data=listings_df, mapping=aes(y=occupancy * 100, x=star_rating)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= star_rating)) + 
              labs(x='Star rating', fill='Star rating',y='Occupancy in %')
             
ggsave(file="occupancy_per_star_rating.png", occ_sr_pl)
occ_sr_pl
```


### Occupancy by Revenue Count



```{r echo=FALSE, message=FALSE, warning=FALSE}

occ_rc_pl <- ggplot(data=listings_df, mapping=aes(y=occupancy * 100, x=reviews_count_bucket)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= reviews_count_bucket)) +   
              labs(x='Revenue Count', fill='Revenue Count', y='Occupancy in %')
             
ggsave(file="occupancy_by_revenue_count.png", occ_rc_pl)
occ_rc_pl
```



### Occupancy by Picture Count



```{r echo=FALSE, message=FALSE, warning=FALSE}

occ_pc_pl <- ggplot(data=listings_df, mapping=aes(y=occupancy * 100, x=picture_count_bucket)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= picture_count_bucket)) +   
              labs(x='Pciture Count', fill='Pciture Count', y='Occupancy in %')
             
ggsave(file="occupancy_by_picture_count.png", occ_pc_pl)
occ_pc_pl
```


## Average daily rate (ADR)


```{r echo=FALSE, message=FALSE, warning=FALSE}

median_adr <- round(median(listings_df$average_daily_rate,na.rm = TRUE), digits=1)
upper_adr <- round(quantile(listings_df$average_daily_rate, probs=c(0.75), na.rm = TRUE), digits=1)
lower_adr <- round(quantile(listings_df$average_daily_rate, probs=c(0.25), na.rm = TRUE), digits=1)

without_ouliers_adr <- round(quantile(listings_df$average_daily_rate, probs=c(0.01,0.99), na.rm = TRUE), digits=1)
```


The median for Average Daily Rate (ADR): EUR`r as.integer(median_adr)`

50% of all listings have a Average Daily Rate (ADR) between 
EUR`r as.integer(lower_adr)` and EUR`r as.integer(upper_adr)`


```{r echo=FALSE, message=FALSE, warning=FALSE}


p5 <- ggplot(data=listings_df, mapping=aes(x=average_daily_rate)) +
        geom_histogram(alpha=0.3, fill='green', color='black', binwidth = 10) +
        scale_x_continuous(breaks=seq(0, 240, 20)) +
        coord_cartesian(xlim=without_ouliers_adr) +
        labs(x='Average Daily Rate(ADR) in EUR', y='Number of listings', title='Average Daily Rate(ADR) of Airbnb listings')

p6 <- ggplot(data=listings_df, mapping=aes(y=average_daily_rate, x=as.factor(''))) +
        geom_boxplot(alpha=0.3, fill='green') +
        coord_cartesian(ylim=c(0, upper_adr * 1.2)) +
        labs( y='Average Daily Rate(ADR) in EUR', x='')
             
ggsave(file="adr.png", grid.arrange(p5, p6, nrow=2))

grid.arrange(p5, p6, nrow=2)
```


### Average Daily rate by room type


```{r echo=FALSE, message=FALSE, warning=FALSE}

adr_rt_pl <- ggplot(data=listings_df, mapping=aes(y=average_daily_rate, x=room_type)) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= room_type)) + 
              scale_y_continuous(breaks=seq(0,600,30)) +
              labs(x='Room Type', fill='Room Type', y='Average Daily Rate')
             
ggsave(file="adr_by_room_type.png", adr_rt_pl)
adr_rt_pl
```



```{r echo=FALSE, message=FALSE, warning=FALSE}

adr_pc_pl <- ggplot(data=listings_df, mapping=aes(y=average_daily_rate, x=as.factor(person_capacity))) +
              geom_boxplot(alpha=0.3, mapping=aes(fill= as.factor(person_capacity))) + 
              scale_y_continuous(breaks=seq(0,1000,50)) +
              labs(x='Person Capacity', fill='Person Capacity', y='Average Daily Rate')
             
ggsave(file="adr_by_person_capacity.png", adr_pc_pl)
adr_pc_pl
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
top_performer <-  function(price_class){
   listings <- listings_df %>% 
                             filter(price_category==price_class) %>%
                             arrange(desc(yearly_revenue)) %>% 
                             top_n(n=10, wt=yearly_revenue)
   listings$occupancy = round(listings$occupancy*100, digits = 1)
   listings$average_daily_rate = round(listings$average_daily_rate,
                                                       digits = 0)
   listings$yearly_revenue = round(listings$yearly_revenue, 
                                                    digits = 0)
   listings
}

print_table <- function(listings){
   kable(listings[ , c(1,11,5,2,4)], 
     col.names = c('Id', 'Name', 'Yearly Revenue', 'Occupancy', 'Average Daily Rate'))
}

plot_performers <- function(listings, price_category){
   filename <- paste('top_performing_', price_category, '.png', sep='')
   title <- paste("Top performing listings in", price_category, 
                  "price category in", LOCATION_NAME, sep = ' ')
   p1 <- ggplot(data=listings, mapping=aes(x=average_daily_rate,y=yearly_revenue)) +
         geom_point(aes(size=revenue_per_available_room,fill=person_capacity), shape=21)+
         scale_size_continuous(range = c(1, 15)) +
         scale_fill_gradientn(colours = terrain.colors(20)) +
         geom_text(data=listings,
                  mapping=aes(x=average_daily_rate, y=yearly_revenue, label=name)) + 
         labs(x='Average Daily Rate (ADR)', y='Yearly Revenue in EUR', fill='Person Capacity', 
              size='Revenue per available room (RevPar)', title=title)
   ggsave(file=filename, p1)
   p1
}
```




# Top performing listings


### Cheap price category
```{r echo=FALSE, message=FALSE, warning=FALSE}
price_category <-  'cheap'
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

top_performering_listings <- top_performer(price_category)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
print_table(top_performering_listings)
```
^Amounts in EUR/Occupancy in %^


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
plot_performers(top_performering_listings, price_category)
      
```


### Budget price category
```{r echo=FALSE, message=FALSE, warning=FALSE}

price_category <-  'budget'
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

top_performering_listings <- top_performer(price_category)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
print_table(top_performering_listings)
```
^Amounts in EUR/Occupancy in %^


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
plot_performers(top_performering_listings, price_category)
      
```



### Midclass price category
```{r echo=FALSE, message=FALSE, warning=FALSE}

price_category <-  'midclass'
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

top_performering_listings <- top_performer(price_category)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
print_table(top_performering_listings)
```
^Amounts in EUR/Occupancy in %^


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
plot_performers(top_performering_listings, price_category)
      
```


### Upper price category
```{r echo=FALSE, message=FALSE, warning=FALSE}

price_category <-  'upper'
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

top_performering_listings <- top_performer(price_category)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
print_table(top_performering_listings)
```
^Amounts in EUR/Occupancy in %^


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
plot_performers(top_performering_listings, price_category)
      
```


### Luxury price category
```{r echo=FALSE, message=FALSE, warning=FALSE}

price_category <-  'luxury'
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

top_performering_listings <- top_performer(price_category)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
print_table(top_performering_listings)
```

^ Amounts in EUR/Occupancy in % ^


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
plot_performers(top_performering_listings, price_category)
      
```


