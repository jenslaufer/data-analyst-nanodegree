---
title: ''
output:
  pdf_document: default
  html_notebook: default
  html_document: default
---


```{r message=FALSE, warning=FALSE, echo=FALSE}
LOCATION_NAME <-  'Bali, Indonesia'
```

```{r message=FALSE, warning=FALSE, echo=FALSE}

library(ggplot2)
library(tidyr)
library(dplyr)
library(GGally)
library(gridExtra)
```

```{r echo=FALSE, message=FALSE, Load_the_Data}
listings_df <- read.csv('data/airbnb.listings.bali.csv')
calendar_df <- read.csv('data/airbnb.listing.calendar.dates.bali.csv')

```


```{r echo=FALSE, message=FALSE}
calendar_df$available = as.logical(calendar_df$available == "true")

```





```{r echo=FALSE, warning=FALSE, message=FALSE, Creation_of_high_level_dataframe}

 daily_revenue <- function(available, price) {
    ifelse(available == FALSE, price, 0)
 }

 average_daily_rate <- function(available, revenue) {
   if(length(which(available==FALSE)) > 0){
      revenue / length(which(available==FALSE))
   }
   else{
      0
   }
 }

 occupancy <- function(available) {
    length(which(available==FALSE)) / length(available)
 }
 
 revenue_per_available_room <- function(available, revenue) {
    average_daily_rate(available, revenue) * occupancy(available)
 }
 
 yearly_revenue <- function(available, revenue) {
    365 * revenue_per_available_room(available,revenue)
 }
 
# Calculation of metrics and join into the listings dataframe
listings_df <- calendar_df %>% 
          mutate(daily_revenue=daily_revenue(available, price.local_price)) %>% 
          group_by(id) %>% 
          summarize(currency=first(price.local_currency),
                    occupancy=occupancy(available),
                    revenue_per_available_room=revenue_per_available_room(available, sum(daily_revenue)),
                    average_daily_rate=average_daily_rate(available, sum(daily_revenue)),
                    yearly_revenue=yearly_revenue(available, sum(daily_revenue))
                    ) %>%
          right_join(listings_df)  
listings_df$star_rating = as.factor(listings_df$star_rating)
listings_df <-  listings_df[ , -which(names(listings_df) %in% c("picture_url", "currency"))]
```

# Airbnb market analysis for `r LOCATION_NAME`


## Yearly revenue

```{r echo=FALSE, message=FALSE, warning=FALSE}

median_yearly_revenue <- round(median(listings_df$yearly_revenue,na.rm = TRUE), digits=0)
upper_yearly_revenue <- round(quantile(listings_df$yearly_revenue, probs=c(0.75), na.rm = TRUE), digits=0)
lower_yearly_revenue <- round(quantile(listings_df$yearly_revenue, probs=c(0.25), na.rm = TRUE), digits=0)
without_ouliers_yearly_revenue <- round(quantile(listings_df$yearly_revenue, probs=c(0.01, 0.99), na.rm = TRUE), digits=0)
```

The median for yearly revenue: EUR `r as.integer(median_yearly_revenue)`

50% of all listings have a yearly revenue between 
EUR `r as.integer(lower_yearly_revenue)` and EUR `r as.integer(upper_yearly_revenue)`


```{r echo=FALSE, message=FALSE, warning=FALSE}


p1 <- ggplot(data=listings_df, mapping=aes(x=yearly_revenue)) +
  geom_histogram(alpha=0.3, fill='blue', color='black') +
  scale_x_log10(breaks=c(100,200,500,1000,2000,5000,10000,20000,50000,100000), 
                labels=c('0.1k','0.2k','0.5k','1k','2k','5k','10k','20k','50k','100k')) +
  labs(x='Yearly revenue', y='Number of listings', fill='Room Type', title='Distribution of yearly revenue of Airbnb listing in Bali, Indonesia')

p2 <- ggplot(data=listings_df, mapping=aes(y=yearly_revenue,x=as.factor(''))) +
             geom_boxplot(alpha=0.3, fill= 'blue') +
             coord_cartesian(ylim=c(0,upper_yearly_revenue * 1.25)) +
  labs(x='Room Type', y='Yearly revenue')
             
ggsave(file="yearly_revenue.png", grid.arrange(p1, p2, nrow=2))

grid.arrange(p1, p2, nrow=2)
```


## Occupancy

```{r echo=FALSE, message=FALSE, warning=FALSE}

median_occupancy <- round(median(listings_df$occupancy,na.rm = TRUE)*100, digits=1)

upper_occupancy <- round(quantile(listings_df$occupancy, probs=c(0.75), na.rm = TRUE) * 100, digits=1)
lower_occupancy <- round(quantile(listings_df$occupancy, probs=c(0.25), na.rm = TRUE) * 100, digits=1)

without_ouliers_occupancy <- round(quantile(listings_df$occupancy, probs=c(0.01, 0.99), na.rm = TRUE) * 100, digits=1)

```

The median for occupancy: `r as.integer(median_occupancy)`%

50% of all listings have a occupancy between 
`r as.integer(lower_occupancy)`% and `r as.integer(upper_occupancy)`%


```{r echo=FALSE, message=FALSE, warning=FALSE}


p3 <- ggplot(data=listings_df, mapping=aes(x=occupancy * 100)) +
        geom_histogram(alpha=0.3, fill='red', color='black') +
        scale_x_continuous(breaks=seq(0,100,10)) +
        coord_cartesian(xlim=without_ouliers_occupancy) +
        labs( x='Occupancy in %', y='Number of listings', title='Occupancy of Airbnb listings')

p4 <- ggplot(data=listings_df, mapping=aes(y=occupancy * 100, x=as.factor(''))) +
        geom_boxplot(alpha=0.3, fill='red') +
        scale_y_continuous(breaks=seq(0,100,10)) +
        coord_cartesian(ylim=c(0, upper_occupancy * 1.2)) +
        labs(y='Occupancy in %', x='')
             
ggsave(file="occupancy.png", grid.arrange(p3, p4, nrow=2))

grid.arrange(p3, p4, nrow=2)
```

## Average daily rate (ADR)


```{r echo=FALSE, message=FALSE, warning=FALSE}

median_adr <- round(median(listings_df$average_daily_rate,na.rm = TRUE), digits=1)
upper_adr <- round(quantile(listings_df$average_daily_rate, probs=c(0.75), na.rm = TRUE), digits=1)
lower_adr <- round(quantile(listings_df$average_daily_rate, probs=c(0.25), na.rm = TRUE), digits=1)

without_ouliers_adr <- round(quantile(listings_df$average_daily_rate, probs=c(0.01,0.99), na.rm = TRUE), digits=1)
```

The median for Average Daily Rate (ADR): EUR`r as.integer(median_adr)`

50% of all listings have a Average Daily Rate (ADR) between 
EUR`r as.integer(lower_adr)` and EUR`r as.integer(upper_adr)`


```{r echo=FALSE, message=FALSE, warning=FALSE}


p5 <- ggplot(data=listings_df, mapping=aes(x=average_daily_rate)) +
        geom_histogram(alpha=0.3, fill='green', color='black', binwidth = 10) +
        scale_x_continuous(breaks=seq(0, 250, 10)) +
        coord_cartesian(xlim=without_ouliers_adr) +
        labs(x='Average Daily Rate(ADR) in EUR', y='Number of listings', title='Average Daily Rate(ADR) of Airbnb listings')

p6 <- ggplot(data=listings_df, mapping=aes(y=average_daily_rate, x=as.factor(''))) +
        geom_boxplot(alpha=0.3, fill='green') +
        coord_cartesian(ylim=c(0, upper_adr * 1.2)) +
        labs( y='Average Daily Rate(ADR) in EUR', x='')
             
ggsave(file="adr.png", grid.arrange(p5, p6, nrow=2))

grid.arrange(p5, p6, nrow=2)
```

## Top performing listings

```{r  echo=FALSE, message=FALSE, warning=FALSE}

top_performering_listings <- listings_df %>%
                             arrange(desc(yearly_revenue)) %>% 
                             top_n(n=10, wt=yearly_revenue)
ggplot(data=top_performering_listings, mapping=aes(x=average_daily_rate,y=yearly_revenue)) +
      geom_point(aes(size=occupancy * 100,fill=person_capacity), shape=21)+
      scale_size_continuous(range = c(1, 15)) +
      scale_fill_gradientn(colours = terrain.colors(20)) +
      geom_text(data=top_performering_listings,
                  mapping=aes(x=average_daily_rate, y=yearly_revenue, label=name)) + 
      labs(x='Average Daily Rate (ADR)', y='Yearly Revenue in EUR', fill='Person Capacity', size='Occupancy in %', title='Top performing listings in Bali, Indonesia')
      


          

```


