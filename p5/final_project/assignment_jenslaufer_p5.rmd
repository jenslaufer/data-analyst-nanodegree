---
title: "Identifying Fraud from Enron Emails and Financial Data"
output:
  pdf_document: default
  html_notebook: default
  html_document: default
---



```{r echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(knitr)
library(kableExtra)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
raw_df = read.csv('raw_data.csv')
cleaned_df = read.csv('cleaned_data.csv')
kbest_results_df = read.csv('kbest.csv')
cv_results_df = read.csv('train_results.csv')
cv_final_results_df = read.csv('final_results.csv')

nulls <- raw_df %>%
  gather(-name, -email_address, -poi, key = "var", value = "val")  %>%
  group_by(var) %>%
  summarise(number = dim(raw_df)[1] - sum(val == 'NaN') -1) %>%
  arrange(desc(number))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
outlier_plots <- function(df){
df %>%
  gather(-name, -email_address, -poi, key = "var", value = "value")  %>%
  group_by(var) %>%
  mutate(max = max(value)) %>%
  ggplot(aes(x = c(''), y=value)) +
    geom_point(position='jitter', alpha=0.2, color=c('blue')) +
    #geom_boxplot(alpha=0.7) +
    geom_text(aes(label=ifelse(value > .6 * max, as.character(name), '')))+
    facet_wrap(~var, scales = "free")
  
}
```



by Jens Laufer, 02/08/2017



## Introduction


Enron was formed in 1985 by a merge of Houston Natural Gas Co and InterNorth 
Inc. Kenneth Lay became Enron's first CEO and Chairman and transformed the 
company into a energy trader and supplier. Deregulation of the energy market and 
an aggressive company policy fired the growth of the company. By 2000 the 
company was one of the biggest companies in the US and a Wallstreet darling. 
Behind the scenes financial losses of the company were hidden behind a network 
of companies with the help of the CEOs Kenneth Lay and Jeff Skilling and the 
CFO Andrew Fastow and others. 
By the end of 2001 the company declared bankruptcy all of a 
sudden to the public. 
The U.S. Securities and Exchange Commission (SEC) began an investigation and 
unhided the biggest case of account fraud in the US history.
Kenneth Lay, Jeff Skilling, Andrew Fastow and several other excutives were later 
sentenced to prison.

The goal of this study is to develop a machine learning model to classify, if a
person is a so called person of interest (POI), who was involved in fraud.

For the study a dataset with email and financial data of 146 excutives is used. 
The original dataset can be downloaded from 
(https://www.cs.cmu.edu/enron/enron_mail_20150507.tgz).


## Data Exloration

The data set consists of `r dim(cleaned_df)[1]` observations and 
`r dim(cleaned_df)[2]-1` features.



### Cleaning the Data



```{r echo=FALSE, message=FALSE, warning=FALSE}
nulls %>%
  ggplot(aes(x=var, y=number)) +
  geom_bar(stat='identity', alpha=0.5, fill=c('blue')) +
  scale_x_discrete(limits=rev(as.factor(nulls$var))) +
  labs(y='Number', x='Feature', title='Number of available features') +
  coord_flip()
```




Occurences of NaN values was checked. It can be seen that for some 
features not that many observations are available. Especially 'loan_advances'
just have 3 observation. This has to be kept in mind for the feature selection.

For financial data the NaN values are replaced with 0.


### Outliers


Outliers need to be removed from the dataset. As fraud needs to be detected this 
need to be done with 
cautious as some POIs have outliers in their financial data. These outliers are
essential. So just undesired outliers need to be removed.

```{r echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
outlier_plots(cleaned_df) 
```

'TOTAL' is removed, as it is the sum of a financial
feature columns.

'THE TRAVEL AGENCY IN THE PARK' is removed as it is not a person.

'LOCKHART EUGENE E' is removed as all features are NaN.



```{r echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
outlier_plots(cleaned_df) 
```
The figure shows the distribution of the dataset after cleaning the 'bad' 
outliers. As mentioned before everything seem ok now, there are only "desired"
outliers.


## Feature Creation


## Feature Selection



```{r echo=FALSE, message=FALSE, warning=FALSE}
  kbest_arranged <- kbest_results_df %>%
                     arrange(desc(score))
  
  kbest_arranged %>%
  ggplot(aes(x=var, y=score)) +
  geom_bar(stat='identity', alpha=0.5, fill=c('red')) +
  scale_x_discrete(limits=rev(as.factor(kbest_arranged$var))) +
  labs(y='Score', x='Feature', size='Number of available features', 
       title='KBest Scores') +
  coord_flip()

```

A univariate feature selection was performed with SelectKBest with all 
features. As it can be seen from the figure the new created feature
'total_financial_benefits' has the highest score. The new feature 'fraction_of_messages_to_poi'
seems also promising, whereas the 'fraction_of_messages_to_poi' has a low score.

'deferral_payments', 'restricted_stock_deferred' and 'director_fees' were
removed from the feature list, as their score is low and there were a lot of NaN values in the dataset.

'to_messages' and 'from_messages' have a low score and are also used for the calculation of the new features, so they can be removed.

As the total_financial_benefits is the sum of 'salary', 'bonus', 'total_stock_value', 'exercised_stock_options'
these features are removed to avoid colinearity.



## Modeling

```{r warning=FALSE, echo=FALSE, fig.height=10, fig.width=20, message=FALSE}
cv_results_df %>%
  gather(-classifier, key = "var", value = "val")  %>%
  ggplot(aes(x = classifier, y=val)) +
    geom_boxplot() +
    facet_wrap(~var, scales = "free", nrow = 2) + coord_flip()
```


### Tuning 

### Conclusion





